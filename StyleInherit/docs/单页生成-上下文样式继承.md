# PPT生成单页-上下文样式继承 技术实现文档

## 1. 概述 (Overview)

### 1.1 背景
当前AI生成PPT单页时，默认采用随机样式，导致新页面与原文档在字体、配色、Logo等方面风格割裂，用户需进行大量二次调整。

### 1.2 目标
- **视觉一致性**：确保新生成的单页/多页内容能无缝融入原文档流。
- **降低成本**：减少用户手动统一格式的时间。
- **技术路径**：通过“截图识别”提取样式参数，输出文本类画面描述（Prompt）和 CSS 样式参数。

---

## 2. 核心逻辑：样式提取与继承 (Core Logic)

### 2.1 路由分发策略 (Routing Strategy)
根据文档类型决定样式提取的方式：

1.  **规则化模板通道 (Rule-based)**
    *   **判定**：识别为可直接提取信息的文档（如 AI 模板、稻壳模板）。
    *   **动作**：直接读取预置 JSON 配置文件。
2.  **视觉识别通道 (Visual Recognition)**
    *   **判定**：用户自定义上传、空白文档、无法识别 ID 的外部模板。
    *   **动作**：调用视觉模型进行“视觉风格提取”。

### 2.2 采样策略 (Sampling Strategy)
采用 **「多点上下文采样 + 母版基准校验」** 策略。

*   **采样点**：以插入页为锚点，提取 **前/后邻近正文页 (共2张)** + **当前应用母版**。
*   **层级关系**：
    *   **母版页 (基准层)**：提供基础“基因信息”（版式、主题色、默认字体），作为兜底。
    *   **上下文正文流 (表现层)**：作为主参考，权重高于母版。
*   **去噪逻辑**：
    *   **一致性校验**：若主参考页与邻近页风格一致，直接采用。
    *   **异常去噪**：若主参考页为“特异风格”（如深色过渡页），降低权重，优先继承出现频率最高的通用样式（众数投票）。

---

## 3. 样式数据结构 (Style Data Structure)

系统需提取以下维度的原子化信息，并分为 `Spec` (逻辑/CSS) 和 `Desc` (感官/Prompt) 两个字段输出。

### 3.1 语义对齐原则
*   **Spec (逻辑轨)**：面向机器渲染 (HTML/CSS)，提供精确数值 (HEX, px, %)。
*   **Desc (感官轨)**：面向 AI 模型 (Banana/SD)，提供质感描述 (材质, 氛围)。

### 3.2 详细字段定义

#### A. Color System (色彩体系)
| 字段 | Spec (CSS) | Desc (Prompt) |
| :--- | :--- | :--- |
| **Background** (背景主色) | HEX / linear-gradient | 环境氛围 (e.g., "深邃午夜蓝渐变") |
| **Primary Text** (正文色) | HEX (需校验对比度) | 亮度与质感 (e.g., "高亮白色文字") |
| **Accent Color** (强调色) | HEX | 视觉焦点作用 (e.g., "霓虹蓝点缀") |

#### B. Typography (字体规范)
| 字段 | Spec (CSS) | Desc (Prompt) |
| :--- | :--- | :--- |
| **Font Family** (字体类型) | Sans-Serif / Serif / Handwritten | 笔画特征 (e.g., "极简几何黑体") |
| **Weight** (字重) | 400 / 700 | 视觉厚度 (e.g., "粗壮醒目") |

#### C. Container & Components (容器与组件)
| 字段 | Spec (CSS) | Desc (Prompt) |
| :--- | :--- | :--- |
| **Corner Radius** (圆角) | 0px / 8px / 50% | 轮廓特征 (e.g., "严谨直角", "柔和圆角") |
| **Border Style** (描边) | Width + Style + Color | 边缘特征 (e.g., "金色细边框") |
| **Shadow** (阴影) | box-shadow 参数 / None | 空间关系 (e.g., "悬浮感", "扁平化") |

#### D. Background & Texture (底纹装饰)
| 字段 | Spec (CSS) | Desc (Prompt) |
| :--- | :--- | :--- |
| **Texture** (纹理) | **降级处理**：取平均色或主色渐变 | **高保真**：材质关键词 (e.g., "磨砂", "水墨") |
| **Opacity** (透明度) | opacity / backdrop-filter | 通透感 (e.g., "毛玻璃效果") |

#### E. Layout & Decoration (版式与修饰)
| 字段 | Spec (CSS) | Desc (Prompt) |
| :--- | :--- | :--- |
| **Margin** (边距) | 百分比 % | 留白程度 (e.g., "大面积留白") |
| **Static Elements** (修饰) | Vertical Bar / Underline / Dot | 修饰细节 (e.g., "左侧竖线装饰") |

---

## 4. 异常处理与熔断机制 (Exception Handling)

| 场景 | 触发条件 | 处理策略 |
| :--- | :--- | :--- |
| **用户主动输入** | Prompt 含明确颜色/风格词 | **[最高优先级]** 按用户指令生成。 |
| **空白/极简场景** | 正文与母版均无显著风格 | **[主题泛化]** 基于内容主题自动生成风格。 |
| **母版失效** | 正文页与母版反差巨大 | **[视觉事实优先]** 忽略母版，以正文页为准。 |
| **风格离散** | 采样页风格完全不统一 | **[众数投票]** 取出现频率最高的风格；若无规律则回滚母版。 |
| **不可编码纹理** | 复杂图片(水墨/3D)做背景 | **[双轨降级]** <br>HTML: 提取主色做纯色背景 (保可读性)<br>AI生图: 提取纹理Prompt重绘 |
| **特异页干扰** | 采样到孤立的深色过渡页 | **[去噪]** 降低该页权重，强制继承邻近的通用风格。 |
| **低对比度** | 文字背景色差过小 | **[强制修正]** 调整亮度或反转文字颜色，确保可读性。 |


